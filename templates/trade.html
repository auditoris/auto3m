{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">ğŸ’¼ Trade Robot (ëª¨ì˜ ê±°ë˜)</h1>

<div class="alert alert-success" role="alert">
    <p class="mb-1"><strong>ê°€ìƒ í˜„ê¸ˆ ì”ê³ :</strong> {{ cash_balance }}ì›</p>
    <p class="mb-0"><strong>ì´ ê³„ì¢Œ í‰ê°€ì•¡ (í˜„ê¸ˆ+ì£¼ì‹):</strong> {{ total_asset_value }}ì›</p>
</div>

{% if robot_status.last_recommended_stock_code %}
<div class="alert alert-info" role="alert">
    <strong>âœ¨ Stock Analysis Robot ì¶”ì²œ ì¢…ëª©:</strong> {{ robot_status.last_recommended_stock_name }} ({{ robot_status.last_recommended_stock_code }}), í˜„ì¬ê°€: {{ robot_status.last_recommended_stock_price }}ì›
</div>
{% endif %}

<div class="card mb-4">
    <div class="card-header">
        ë¡œë´‡ ìƒíƒœ
    </div>
    <div class="card-body">
        <p class="card-text"><strong>ìƒíƒœ:</strong> <span class="badge bg-{{ 'success' if 'ì™„ë£Œ' in robot_status.tr_status else 'warning' if 'ì‹¤í–‰ ì¤‘' in robot_status.tr_status else 'danger' if 'ì˜¤ë¥˜' in robot_status.tr_status else 'info' }}">{{ robot_status.tr_status }}</span></p>
        <p class="card-text"><strong>ë§ˆì§€ë§‰ ì‹¤í–‰:</strong> {{ robot_status.tr_last_run }}</p>
        <p class="card-text"><strong>ë§ˆì§€ë§‰ ë™ì‘:</strong> {{ robot_status.tr_last_action }}</p>
    </div>
</div>


<form method="POST" action="{{ url_for('trade') }}" class="mb-4 p-4 border rounded shadow-sm bg-light">
    <h5 class="mb-3">ëª¨ì˜ ë§¤ìˆ˜/ë§¤ë„ ì£¼ë¬¸ (ìˆ˜ë™ ì‹¤í–‰)</h5>
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="symbol_name" class="form-label">ì¢…ëª©ëª…:</label>
            <input type="text" class="form-control" id="symbol_name" name="symbol_name"
                   value="{{ robot_status.last_recommended_stock_name if robot_status.last_recommended_stock_name else '' }}" required>
        </div>
        <div class="col-md-6">
            <label for="symbol_code" class="form-label">ì¢…ëª© ì½”ë“œ:</label>
            <input type="text" class="form-control" id="symbol_code" name="symbol_code"
                   value="{{ robot_status.last_recommended_stock_code if robot_status.last_recommended_stock_code else '' }}" required>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="order_type" class="form-label">ì£¼ë¬¸ ìœ í˜•:</label>
            <select class="form-select" id="order_type" name="order_type" required>
                <option value="">ì„ íƒ</option>
                <option value="ë§¤ìˆ˜">ë§¤ìˆ˜</option>
                <option value="ë§¤ë„">ë§¤ë„</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="price_type" class="form-label">ê°€ê²© ìœ í˜•:</label>
            <select class="form-select" id="price_type" name="price_type" required>
                <option value="">ì„ íƒ</option>
                <option value="ì‹œì¥ê°€">ì‹œì¥ê°€</option>
                <option value="ì§€ì •ê°€">ì§€ì •ê°€</option>
            </select>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="order_price" class="form-label">ì§€ì • ê°€ê²© (ì‹œì¥ê°€ ì„ íƒ ì‹œ ë¬´ì‹œ):</label>
            <input type="number" class="form-control" id="order_price" name="order_price" placeholder="ì˜ˆ: 75000">
        </div>
        <div class="col-md-6">
            <label for="quantity" class="form-label">ìˆ˜ëŸ‰:</label>
            <input type="number" class="form-control" id="quantity" name="quantity" placeholder="ì˜ˆ: 10" required>
        </div>
    </div>
    <button type="submit" class="btn btn-primary">ì£¼ë¬¸ ì‹¤í–‰</button>
</form>

<div class="card mb-4">
    <div class="card-header">
        í˜„ì¬ ë³´ìœ  í¬íŠ¸í´ë¦¬ì˜¤
    </div>
    <div class="card-body">
        {% if portfolio %}
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>ì¢…ëª©ì½”ë“œ</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ë§¤ì…ë‹¨ê°€</th>
                            <th>ë³´ìœ ìˆ˜ëŸ‰</th>
                            <th>ë§¤ì…ê¸ˆì•¡</th>
                            <th>í˜„ì¬ê°€</th>
                            <th>í‰ê°€ì†ìµ</th>
                            <th>ìˆ˜ìµë¥ (%)</th>
                            <th>ìµœì¢…ì—…ë°ì´íŠ¸</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in portfolio.iterrows() %}
                        <tr>
                            <td>{{ row[1].stock_code }}</td>
                            <td>{{ row[1].stock_name }}</td>
                            <td>{{ '%sì›' % '{:,.0f}'.format(row[1].ë§¤ì…ë‹¨ê°€) }}</td>
                            <td>{{ '%sì£¼' % '{:,.0f}'.format(row[1].ë³´ìœ ìˆ˜ëŸ‰) }}</td>
                            <td>{{ '%sì›' % '{:,.0f}'.format(row[1].ë§¤ì…ê¸ˆì•¡) }}</td>
                            <td>{{ '%sì›' % '{:,.0f}'.format(row[1].í˜„ì¬ê°€) if row[1].í˜„ì¬ê°€ is not none else 'N/A' }}</td>
                            <td class="{{ 'text-success' if row[1].í‰ê°€ì†ìµ > 0 else 'text-danger' if row[1].í‰ê°€ì†ìµ < 0 else '' }}">
                                {{ '%sì›' % '{:,.0f}'.format(row[1].í‰ê°€ì†ìµ) if row[1].í‰ê°€ì†ìµ is not none else 'N/A' }}
                            </td>
                            <td class="{{ 'text-success' if row[1].ìˆ˜ìµë¥  > 0 else 'text-danger' if row[1].ìˆ˜ìµë¥  < 0 else '' }}">
                                {{ '%s%%' % '{:,.2f}'.format(row[1].ìˆ˜ìµë¥ ) if row[1].ìˆ˜ìµë¥  is not none else 'N/A' }}
                            </td>
                            <td>{{ row[1].last_updated }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted">ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </div>
</div>

{% if asset_chart_url %}
<div class="card mb-4">
    <div class="card-header">
        ê°€ìƒ í˜„ê¸ˆ ì”ê³  ë³€í™” ì¶”ì´
    </div>
    <div class="card-body text-center">
        <img src="data:image/png;base64,{{ asset_chart_url }}" class="img-fluid" alt="Asset Chart">
        <p class="text-muted mt-2">â€» ì”ê³  ë³€í™” ì¶”ì´ëŠ” ê±°ë˜ ë°œìƒ ì‹œì ì˜ í˜„ê¸ˆ ì”ê³ ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
    </div>
</div>
{% endif %}

<div class="card mb-4">
    <div class="card-header">
        ìµœì‹  ê±°ë˜ ë¡œê·¸ (DBì—ì„œ ì¡°íšŒ)
    </div>
    <div class="card-body">
        {% if trade_log %}
            {{ trade_log | safe }}
        {% else %}
            <p class="text-muted">ê¸°ë¡ëœ ê±°ë˜ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </div>
</div>

{% endblock %}